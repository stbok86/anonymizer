#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º NLP service
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'app'))

from nlp_adapter import NLPAdapter

def test_hybrid_government_strategy():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–∏–±—Ä–∏–¥–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ì–ò–ë–†–ò–î–ù–û–ô –°–¢–†–ê–¢–ï–ì–ò–ò –î–ï–¢–ï–ö–¶–ò–ò –ì–û–°–û–†–ì–ê–ù–û–í")
    print("=" * 80)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã
    test_texts = [
        # –¢–µ–∫—Å—Ç 1: –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω—ã –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ Phrase Matcher)
        """
        –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ —Å–≤—è–∑–∏ –ü–µ—Ä–º—Å–∫–æ–≥–æ –∫—Ä–∞—è 
        –∑–∞–∫–ª—é—á–∏–ª–æ –¥–æ–≥–æ–≤–æ—Ä —Å –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –æ —Ä–∞–∑–≤–∏—Ç–∏–∏ —Å–∏—Å—Ç–µ–º—ã.
        """,
        
        # –¢–µ–∫—Å—Ç 2: –°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ (–¥–æ–ª–∂–Ω—ã –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ spaCy NER)
        """
        –¢–ó –±—ã–ª–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ú–∏–Ω—Ñ–∏–Ω–æ–º, –∞ –ß–¢–ó - –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ–º –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é 
        –∏–º—É—â–µ—Å—Ç–≤–æ–º –∏ –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ü–µ—Ä–º—Å–∫–æ–≥–æ –∫—Ä–∞—è.
        """,
        
        # –¢–µ–∫—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å false positives
        """
        –û–û–û "–ö–ê–ú–ê –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –≥–æ—Ä–æ–¥–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç—É
        —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–æ–º. –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã 
        –°–∏—Å—Ç–µ–º—ã –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ü–û –∏ –ë–î.
        """,
        
        # –¢–µ–∫—Å—Ç 4: –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        """
        –ú–ò–ù–ò–°–¢–ï–†–°–¢–í–û –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ì–û –†–ê–ó–í–ò–¢–ò–Ø –ò –°–í–Ø–ó–ò –ü–ï–†–ú–°–ö–û–ì–û –ö–†–ê–Ø
        –ï–î–ò–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –§–ò–ù–ê–ù–°–û–í–û-–•–û–ó–Ø–ô–°–¢–í–ï–ù–ù–û–ô 
        –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨–Æ –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ô –ë–Æ–î–ñ–ï–¢–ù–û–ô –°–§–ï–†–´ –ü–ï–†–ú–°–ö–û–ì–û –ö–†–ê–Ø
        
        –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Ç 14 –∞–≤–≥—É—Å—Ç–∞ 2023 –≥. ‚Ññ 13/–û–ö-2023 
        –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–æ–º¬ª (2 –æ—á–µ—Ä–µ–¥—å)
        
        –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑—á–∏–∫: –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ —Å–≤—è–∑–∏
        –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—á–∏–∫–∏: –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏–º—É—â–µ—Å—Ç–≤–æ–º –∏ 
        –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –ü–µ—Ä–º—Å–∫–æ–≥–æ –∫—Ä–∞—è
        –ü–æ–¥—Ä—è–¥—á–∏–∫: –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é ¬´–ö–ê–ú–ê –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏¬ª
        """
    ]
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–∞–ø—Ç–µ—Ä
        print("üìö –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NLP –∞–¥–∞–ø—Ç–µ—Ä–∞...")
        adapter = NLPAdapter()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
        categories = adapter.config.get_available_categories()
        if 'government_org' not in categories:
            print("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è government_org –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
            return
            
        strategy_name = adapter.config.get_detection_strategy_name('government_org')
        if strategy_name != 'hybrid_government':
            print(f"‚ùå –î–ª—è government_org –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è {strategy_name}, –æ–∂–∏–¥–∞–µ—Ç—Å—è hybrid_government")
            return
        
        print(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞: —Å—Ç—Ä–∞—Ç–µ–≥–∏—è {strategy_name} –¥–ª—è government_org")
        print()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ç–µ–∫—Å—Ç
        for i, text in enumerate(test_texts, 1):
            print(f"üìù –¢–ï–°–¢ {i}: {text.strip()[:50]}...")
            print("-" * 60)
            
            try:
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
                results = adapter.find_sensitive_data(text)
                
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                gov_results = [r for r in results if r.get('category') == 'government_org']
                
                print(f"üéØ –ù–∞–π–¥–µ–Ω–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π: {len(gov_results)}")
                
                if gov_results:
                    for j, result in enumerate(gov_results, 1):
                        print(f"   {j}. üèõÔ∏è '{result['original_value']}'")
                        print(f"       üìç –ü–æ–∑–∏—Ü–∏—è: {result['position']['start']}-{result['position']['end']}")
                        print(f"       üéØ Confidence: {result['confidence']:.3f}")
                        print(f"       üîß –ú–µ—Ç–æ–¥: {result['method']}")
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                        if 'hybrid_info' in result:
                            hybrid_info = result['hybrid_info']
                            print(f"       üî¨ –¢–∏–ø: {hybrid_info['organization_type']}")
                            print(f"       üìä –ò—Å—Ç–æ—á–Ω–∏–∫: {hybrid_info['source_method']}")
                            print(f"       üèõÔ∏è –ì–æ—Å–æ—Ä–≥–∞–Ω: {hybrid_info['is_government']}")
                        print()
                else:
                    print("   ‚ùå –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                
                print()
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞ {i}: {str(e)}")
                print()
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {str(e)}")
        import traceback
        traceback.print_exc()

def test_strategy_comparison():
    """–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–∞–±–æ—Ç—É hybrid_government vs best_confidence"""
    
    print("\nüî¨ –°–†–ê–í–ù–ï–ù–ò–ï –°–¢–†–ê–¢–ï–ì–ò–ô")
    print("=" * 80)
    
    test_text = """
    –ú–ò–ù–ò–°–¢–ï–†–°–¢–í–û –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ì–û –†–ê–ó–í–ò–¢–ò–Ø –ò –°–í–Ø–ó–ò –ü–ï–†–ú–°–ö–û–ì–û –ö–†–ê–Ø –∑–∞–∫–ª—é—á–∏–ª–æ
    –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å –û–û–û "–ö–ê–ú–ê –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –ï–ò–° –£–§–•–î –ü–ö. –°–∏—Å—Ç–µ–º–∞ 
    –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º—É—â–µ—Å—Ç–≤–æ–º.
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–¢–ó) –∏ –ß–∞—Å—Ç–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–ß–¢–ó) —Å–æ–¥–µ—Ä–∂–∞—Ç
    —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –û–±—â–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–º—É –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é (–û–ü–û).
    """
    
    print(f"üìù –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç:\n{test_text}\n")
    
    try:
        # –¢–µ—Å—Ç —Å hybrid_government (—Ç–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
        print("1Ô∏è‚É£ –ì–ò–ë–†–ò–î–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø (hybrid_government):")
        print("-" * 50)
        
        adapter_hybrid = NLPAdapter()
        results_hybrid = adapter_hybrid.find_sensitive_data(test_text)
        gov_results_hybrid = [r for r in results_hybrid if r.get('category') == 'government_org']
        
        print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(gov_results_hybrid)} –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π")
        for result in gov_results_hybrid:
            print(f"   üèõÔ∏è '{result['original_value']}' (conf: {result['confidence']:.3f}, –º–µ—Ç–æ–¥: {result['method']})")
        
        print()
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ç–æ–¥–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –ø–æ–∏—Å–∫–µ
        all_methods = set(r['method'] for r in gov_results_hybrid)
        print(f"   üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã: {', '.join(all_methods)}")
        print()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö: {str(e)}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    test_hybrid_government_strategy()
    test_strategy_comparison()
    
    print("\n‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")