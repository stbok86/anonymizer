#!/usr/bin/env python3
"""
–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –ó–ê–ú–ï–ù–´ –¢–ï–ö–°–¢–ê –í DOCX
=========================================

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã—è–≤–ª—è–µ—Ç —Ç–æ—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∑–∞–º–µ–Ω—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.
"""

import os
import sys
import json
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –∫ –º–æ–¥—É–ª—è–º
unified_service_path = os.path.join(os.path.dirname(__file__), 'unified_document_service', 'app')
sys.path.append(unified_service_path)

try:
    from docx import Document
    from block_builder import BlockBuilder
    from formatter_applier import FormatterApplier
    print("‚úÖ –ú–æ–¥—É–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("‚ö†Ô∏è  –°–∏–º—É–ª–∏—Ä—É–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π")

def diagnose_replacement_issues():
    """
    –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–º–µ–Ω–æ–π —Ç–µ–∫—Å—Ç–∞
    """
    print("üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú –ó–ê–ú–ï–ù–´ –¢–ï–ö–°–¢–ê")
    print("=" * 80)
    
    print("üìã –í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
    print("-" * 25)
    
    print("1Ô∏è‚É£  –ü–†–û–ë–õ–ï–ú–ê: –ú–µ—Ç–æ–¥ _replace_in_paragraph() —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏")
    print("   üìç –§–∞–π–ª: formatter_applier.py, —Å—Ç—Ä–æ–∫–∏ 212-250")
    print("   üö® –û—à–∏–±–∫–∞: –ó–∞–º–µ–Ω–∞ —á–µ—Ä–µ–∑ paragraph.text —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print()
    
    print("   üíª –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:")
    print("""
    def _replace_in_paragraph(self, paragraph, original_value, replacement_value, position):
        paragraph_text = getattr(paragraph, 'text', '')
        
        if original_value in paragraph_text:
            # ‚ùå –≠–¢–û –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç runs –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            paragraph.text = paragraph.text.replace(original_value, replacement_value)
            
            # ‚ùå –ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã paragraph.text —Å—Ç–∞—Ä—ã–µ runs –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã!
            if self.highlight_replacements and paragraph.runs:
                for run in paragraph.runs:  # –≠—Ç–∏ runs —É–∂–µ –Ω–µ —Ç–µ!
                    if replacement_value in run.text:
                        run.font.highlight_color = self.replacement_color
    """)
    print()
    
    print("2Ô∏è‚É£  –ü–†–û–ë–õ–ï–ú–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å DOCX —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π")
    print("   üìç –í DOCX –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã —Å–æ—Å—Ç–æ—è—Ç –∏–∑ runs (—Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)")
    print("   üö® –ü—Ä–∏ –∑–∞–º–µ–Ω–µ paragraph.text –≤—Å–µ runs —É–¥–∞–ª—è—é—Ç—Å—è –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω –Ω–æ–≤—ã–π")
    print("   üö® –°—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ runs —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏")
    print()
    
    print("3Ô∏è‚É£  –ü–†–û–ë–õ–ï–ú–ê: –õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è")
    print("   üìç –ö–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ runs –ø–æ—Å–ª–µ –∏—Ö —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è")
    print("   üö® paragraph.runs –ø–æ—Å–ª–µ paragraph.text = ... —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã")
    print()
    
    print("üîß –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï:")
    print("-" * 20)
    
    print("‚úÖ –ù—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å runs –Ω–∞–ø—Ä—è–º—É—é, –Ω–µ –∏–∑–º–µ–Ω—è—è paragraph.text")
    print("‚úÖ –ù–∞–π—Ç–∏ run —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ç–µ–∫—Å—Ç –∏ –∑–∞–º–µ–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ")
    print("‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ run")
    print()
    
    print("üíª –ü–†–ê–í–ò–õ–¨–ù–´–ô –ö–û–î:")
    print("""
def _replace_in_paragraph(self, paragraph, original_value, replacement_value, position):
    try:
        replacement_made = False
        
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º runs –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ
        for run in paragraph.runs:
            if original_value in run.text:
                # –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ run (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ!)
                run.text = run.text.replace(original_value, replacement_value)
                replacement_made = True
                
                # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ —ç—Ç–æ–º—É –∂–µ run
                if self.highlight_replacements:
                    run.font.highlight_color = self.replacement_color
                
                print(f"‚úÖ –ó–∞–º–µ–Ω–∞ –≤ run: '{original_value}' ‚Üí '{replacement_value}'")
        
        return replacement_made
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ: {str(e)}")
        return False
    """)
    print()
    
    print("4Ô∏è‚É£  –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
    print("-" * 30)
    
    print("üîç –ê) –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π —Å–∏–º–≤–æ–ª–æ–≤")
    print("   ‚Ä¢ –ö–∞–≤—ã—á–∫–∏ ¬´¬ª –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–¥–∏—Ä–æ–≤–∫–∞—Ö")
    print("   ‚Ä¢ –ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏")
    print()
    
    print("üîç –ë) –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º")
    print("   ‚Ä¢ position –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–º–µ–Ω–µ")
    print("   ‚Ä¢ –ù—É–∂–Ω–æ —Ç–æ—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ")
    print()
    
    print("üîç –í) –ü—Ä–æ–±–ª–µ–º–∞ —Å BlockBuilder")
    print("   ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ element –∫ paragraph")
    print("   ‚Ä¢ –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å mapping –±–ª–æ–∫–æ–≤")
    print()
    
    print("üõ†Ô∏è  –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:")
    print("-" * 20)
    
    print("1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å _replace_in_paragraph –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å runs")
    print("2. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞")
    print("3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)")
    print("4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å BlockBuilder")
    print("5. –î–æ–±–∞–≤–∏—Ç—å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤")
    print()
    
    print("‚ö° –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
    print("-" * 25)
    
    print("1Ô∏è‚É£  –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ _replace_in_paragraph")
    print("2Ô∏è‚É£  –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print("3Ô∏è‚É£  –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ")
    print()
    
    print("üéØ –≠–¢–û –û–ë–™–Ø–°–ù–Ø–ï–¢ –ü–†–û–ë–õ–ï–ú–£:")
    print("-" * 30)
    
    print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –∑–∞–º–µ–Ω—É")
    print("üìã –¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
    print("‚ùå –ù–û –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ _replace_in_paragraph")
    print()
    
    # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã
    print("üß™ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ü–†–û–ë–õ–ï–ú–´:")
    print("-" * 27)
    
    print("–ò—Å—Ö–æ–¥–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ:")
    print("  runs[0].text = '–û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é '")
    print("  runs[1].text = '¬´–ö–ê–ú–ê –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏¬ª'")
    print("  paragraph.text = '–û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é ¬´–ö–ê–ú–ê –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏¬ª'")
    print()
    
    print("–ü–æ—Å–ª–µ paragraph.text = paragraph.text.replace(...):")
    print("  ‚ùå –í—Å–µ —Å—Ç–∞—Ä—ã–µ runs —É–¥–∞–ª–µ–Ω—ã!")
    print("  ‚úÖ runs[0].text = '–û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é 4f8b1c2d...'")
    print("  ‚ùå –ù–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ!")
    print("  ‚ùå –ò –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –Ω–æ–≤–æ–º—É run, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è")
    print()
    
    print("üèÅ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:")
    print("-" * 15)
    print("–ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ê–ë–û–¢–ê –° DOCX RUNS")
    print("–†–µ—à–µ–Ω–∏–µ: –ü–ï–†–ï–ü–ò–°–ê–¢–¨ _replace_in_paragraph –î–õ–Ø –†–ê–ë–û–¢–´ –° RUNS")
    print()
    print("=" * 80)

if __name__ == "__main__":
    diagnose_replacement_issues()